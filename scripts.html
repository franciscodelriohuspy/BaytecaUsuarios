<script>
  (function () {
    const state = {
      session: null,
      page: document.body.dataset.page
    };

    const EMPTY_FIELD = '\u00A0';

    const STATIC_SEGUROS_DATA = {
      seguros: [
        {
          titulo: 'Seguro de Vida',
          descripcion: 'Protege a los tuyos con una cobertura personalizada a tus necesidades.',
          url: 'https://huspy.typeform.com/to/sKStpQM6'
        },
        {
          titulo: 'Seguro de Hogar',
          descripcion: 'Cuida tu vivienda y tus bienes frente a cualquier imprevisto.',
          url: 'https://huspy.typeform.com/to/RXB2stWf'
        },
        {
          titulo: 'Seguro de Salud',
          descripcion: 'Accede a la mejor cobertura médica con la ayuda de nuestro equipo.',
          url: 'https://huspy.typeform.com/to/RXB2stWf'
        }
      ],
      adicionales: [
        {
          titulo: 'Alarma Despertador',
          descripcion: '¿Tienes seguros que no puedes cambiar aún? Cuéntanos cuándo vencen y te avisamos con una propuesta.',
          url: 'https://huspy.typeform.com/to/kGQfaxnG'
        },
        {
          titulo: 'Recomiéndanos',
          descripcion: 'Comparte Bayteca con tus contactos. ¡Gracias por confiar en nosotros! ',
          url: 'https://huspy.typeform.com/to/OneCu9av'
        }
      ],
      tasacion: {
        titulo: 'Solicitar tasación con Tinsa',
        descripcion: 'Gestiona tu tasación de forma rápida con nuestro socio Tinsa.',
        url: 'https://store.tinsa.es/orders/appraisal/location?partnerId=BAYT&referralOrigin=web-generalista'
      }
    };

    document.addEventListener('DOMContentLoaded', function () {
      if (state.page === 'login') {
        initLogin();
      } else {
        initApp();
      }
    });

    function initLogin() {
      const form = document.getElementById('loginForm');
      const messageEl = document.getElementById('loginMessage');
      const googleButton = document.getElementById('googleSignIn');

      const submitButton = form ? form.querySelector('button[type="submit"]') : null;

      if (googleButton) {
        googleButton.addEventListener('click', function () {
          if (!canUseGoogleScript_()) {
            showLoginMessage('No es posible conectar con Google en estos momentos. Inténtalo de nuevo más tarde.', 'error');
            return;
          }

          toggleButtonState_(googleButton, true);
          showLoginMessage('Validando con tu cuenta de Google…', 'loading');

          google.script.run
            .withSuccessHandler(function (response) {
              handleLoginResponse_(response, submitButton, googleButton);
            })
            .withFailureHandler(function (error) {
              handleLoginFailure_(error, googleButton);
            })
            .loginWithGoogle();
        });
      }

      if (!form) {
        return;
      }

      form.addEventListener('submit', function (event) {
        event.preventDefault();
        if (!canUseGoogleScript_()) {
          showLoginMessage('No es posible conectar con el servidor. Revisa tu conexión e inténtalo en unos minutos.', 'error');
          return;
        }

        const email = form.email.value;
        const password = form.password.value;
        showLoginMessage('Validando tus datos...', 'loading');
        toggleButtonState_(submitButton, true);

        google.script.run
          .withSuccessHandler(function (response) {
            handleLoginResponse_(response, submitButton, googleButton);
          })
          .withFailureHandler(function (error) {
            handleLoginFailure_(error, submitButton);
          })
          .login(email, password);
      });

      function showLoginMessage(text, type) {
        if (!messageEl) return;
        messageEl.textContent = text;
        messageEl.className = 'login__message';
        if (type === 'error') {
          messageEl.classList.add('is-error');
        }
        if (type === 'success') {
          messageEl.classList.add('is-success');
        }
        if (type === 'loading') {
          messageEl.classList.add('is-loading');
        }
      }

      function handleLoginResponse_(response, submitBtn, googleBtn) {
        if (response && response.success) {
          var successMessage = '¡Bienvenido! Estamos preparando tu panel…';
          if (response.hasOperacion === false && response.message) {
            successMessage = response.message + ' En cuanto vinculemos tu expediente podrás ver tu panel completo.';
          }
          showLoginMessage(successMessage, 'success');
          var redirectDelay = response.hasOperacion === false ? 1500 : 500;
          var redirectUrl = response.redirectUrl;
          setTimeout(function () {
            var targetWindow = window.top || window;
            if (redirectUrl) {
              targetWindow.location.href = redirectUrl;
              return;
            }
            navigateTo('index');
          }, redirectDelay);
          return;
        }

        showLoginMessage((response && response.message) || 'No ha sido posible iniciar sesión.', 'error');
        toggleButtonState_(submitBtn, false);
        toggleButtonState_(googleBtn, false);
      }

      function handleLoginFailure_(error, buttonToUnlock) {
        showLoginMessage((error && error.message) || 'No ha sido posible iniciar sesión.', 'error');
        toggleButtonState_(buttonToUnlock, false);
      }

      function toggleButtonState_(button, shouldDisable) {
        if (!button) return;
        button.disabled = !!shouldDisable;
        button.classList.toggle('is-disabled', !!shouldDisable);
      }

      function canUseGoogleScript_() {
        return typeof google !== 'undefined' && google.script && google.script.run;
      }
    }

    function initApp() {
      attachNavigation();
      attachLogout();

      google.script.run
        .withSuccessHandler(function (session) {
          if (!session || !session.email) {
            navigateTo('login');
            return;
          }
          state.session = session;
          updateSessionUI(session);
          loadPageData();
        })
        .withFailureHandler(function () {
          navigateTo('login');
        })
        .getSession();
    }

    function attachNavigation() {
      const links = document.querySelectorAll('.nav-link, .card');
      links.forEach(function (link) {
        const target = link.dataset.target || link.dataset.nav;
        if (!target) return;
        link.addEventListener('click', function (event) {
          event.preventDefault();
          navigateTo(target);
        });
      });

      const backButton = document.getElementById('backToDashboard');
      if (backButton) {
        backButton.addEventListener('click', function () {
          navigateTo('index');
        });
      }

      const datosVolver = document.getElementById('datosVolver');
      if (datosVolver) {
        datosVolver.addEventListener('click', function () {
          navigateTo('index');
        });
      }
    }

    function attachLogout() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (!logoutBtn) return;
      logoutBtn.addEventListener('click', function () {
        google.script.run
          .withSuccessHandler(function () {
            navigateTo('login');
          })
          .withFailureHandler(function () {
            navigateTo('login');
          })
          .logout();
      });
    }

    function updateSessionUI(session) {
      const nameEls = document.querySelectorAll('[data-user-name]');
      const emailEls = document.querySelectorAll('[data-user-email]');
      nameEls.forEach(function (el) {
        el.textContent = session.nombre || 'Cliente Bayteca';
      });
      emailEls.forEach(function (el) {
        el.textContent = session.email || '—';
      });

      const greetingName = document.getElementById('greetingName');
      if (greetingName) {
        greetingName.textContent = session.nombre || 'cliente Bayteca';
      }
    }

    function loadPageData() {
      switch (state.page) {
        case 'index':
          loadDashboard();
          break;
        case 'estado':
          loadEstado();
          break;
        case 'datos':
          loadDatos();
          break;
        case 'seguros':
          loadSeguros();
          break;
      }
    }

    function loadDashboard() {
      const summaryEtapa = document.getElementById('summaryEtapa');
      const summaryGestor = document.getElementById('summaryGestor');
      const summaryDias = document.getElementById('summaryDias');
      const summaryId = document.getElementById('summaryId');

      if (summaryEtapa) summaryEtapa.textContent = EMPTY_FIELD;
      if (summaryGestor) summaryGestor.textContent = 'Gestor asignado: ' + EMPTY_FIELD;
      if (summaryDias) summaryDias.textContent = 'Días en el mismo estado: ' + EMPTY_FIELD;
      if (summaryId) summaryId.textContent = 'ID de operación: ' + EMPTY_FIELD;
    }

    function loadEstado() {
      const container = document.getElementById('estadoContainer');
      if (!container) return;
      container.classList.remove('is-loading');

      const infoBasica = document.getElementById('infoBasica');
      if (infoBasica) {
        infoBasica.innerHTML = '';
        appendMeta(infoBasica, 'ID de operación', EMPTY_FIELD);
        appendMeta(infoBasica, 'Gestor', EMPTY_FIELD);
        appendMeta(infoBasica, 'Estado', EMPTY_FIELD);
        appendMeta(infoBasica, 'Etapa actual', EMPTY_FIELD);
        appendMeta(infoBasica, 'Días en el mismo estado', EMPTY_FIELD);
      }

      const descripcion = document.getElementById('estadoDescripcion');
      if (descripcion) {
        descripcion.textContent = EMPTY_FIELD;
      }

      const meta = document.getElementById('estadoMeta');
      if (meta) {
        meta.textContent = EMPTY_FIELD;
      }

      const steps = document.querySelectorAll('.progress-bar .step');
      steps.forEach(function (step) {
        step.classList.remove('active');
      });

      const fill = document.getElementById('progressFill');
      if (fill) {
        fill.style.width = '0%';
      }
    }

    function appendMeta(parent, label, value) {
      const meta = document.createElement('div');
      meta.className = 'meta-item';
      meta.innerHTML = '<strong>' + label + ':</strong> ' + value;
      parent.appendChild(meta);
    }

    function loadDatos() {
      const container = document.getElementById('datosContenido');
      const airtableCard = document.getElementById('airtableCard');
      if (!container) return;

      container.classList.remove('is-loading');
      container.innerHTML = '';

      const grid = document.createElement('div');
      grid.className = 'datos-grid';
      grid.appendChild(createDatoItem('ID de la operación', EMPTY_FIELD));
      grid.appendChild(createDatoItem('Nombre del cliente', EMPTY_FIELD));
      grid.appendChild(createDatoItem('Gestor asignado', EMPTY_FIELD));
      grid.appendChild(createDatoItem('Días en el mismo estado', EMPTY_FIELD));
      grid.appendChild(createDatoItem('DNI', EMPTY_FIELD));
      grid.appendChild(createDatoItem('Precio de la vivienda', EMPTY_FIELD));
      grid.appendChild(createDatoItem('Importe de hipoteca', EMPTY_FIELD));
      container.appendChild(grid);

      if (airtableCard) {
        airtableCard.hidden = true;
      }
    }

    function createDatoItem(label, value) {
      const item = document.createElement('div');
      item.className = 'datos-item';
      const labelEl = document.createElement('span');
      labelEl.className = 'label';
      labelEl.textContent = label;
      const valueEl = document.createElement('span');
      valueEl.className = 'value';
      valueEl.textContent = value;
      item.appendChild(labelEl);
      item.appendChild(valueEl);
      return item;
    }

    function loadSeguros() {
      const grid = document.getElementById('segurosGrid');
      const tasacionCard = document.getElementById('tasacionCard');
      if (!grid || !tasacionCard) return;

      grid.classList.remove('is-loading');
      grid.innerHTML = '';

      const seguros = STATIC_SEGUROS_DATA.seguros || [];
      seguros.forEach(function (seguro) {
        grid.appendChild(createSeguroCard(seguro));
      });

      const adicionales = STATIC_SEGUROS_DATA.adicionales || [];
      adicionales.forEach(function (seguro) {
        grid.appendChild(createSeguroCard(seguro));
      });

      tasacionCard.innerHTML = '';
      const titulo = document.createElement('h2');
      titulo.textContent = STATIC_SEGUROS_DATA.tasacion && STATIC_SEGUROS_DATA.tasacion.titulo
        ? STATIC_SEGUROS_DATA.tasacion.titulo
        : 'Tasación disponible';
      const descripcion = document.createElement('p');
      descripcion.textContent = STATIC_SEGUROS_DATA.tasacion && STATIC_SEGUROS_DATA.tasacion.descripcion
        ? STATIC_SEGUROS_DATA.tasacion.descripcion
        : '';
      const link = document.createElement('a');
      link.className = 'btn';
      link.href = STATIC_SEGUROS_DATA.tasacion && STATIC_SEGUROS_DATA.tasacion.url
        ? STATIC_SEGUROS_DATA.tasacion.url
        : '#';
      link.target = '_blank';
      link.rel = 'noopener';
      link.textContent = 'Solicitar tasación';
      tasacionCard.appendChild(titulo);
      tasacionCard.appendChild(descripcion);
      tasacionCard.appendChild(link);
    }

    function createSeguroCard(seguro) {
      const card = document.createElement('div');
      card.className = 'seguro-card';
      const titulo = document.createElement('h3');
      titulo.textContent = seguro.titulo || 'Servicio';
      const descripcion = document.createElement('p');
      descripcion.textContent = seguro.descripcion || '';
      const link = document.createElement('a');
      link.className = 'btn';
      link.href = seguro.url || '#';
      link.target = '_blank';
      link.rel = 'noopener';
      link.textContent = 'Quiero saber más';
      card.appendChild(titulo);
      card.appendChild(descripcion);
      card.appendChild(link);
      return card;
    }

    function navigateTo(page) {
      const targetWindow = window.top || window;
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function (url) {
            targetWindow.location.href = url;
          })
          .buildPageUrl(page);
        return;
      }

      const url = new URL(window.location.href);
      url.searchParams.set('page', page);
      targetWindow.location.href = url.toString();
    }
  })();
</script>
